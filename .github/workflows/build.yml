Name: build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        target:
          - win64
          - macos64
          - linux64
          - android
        include:
          - target: win64
            os: windows-latest
          - target: macos64
            os: macos-latest
          - target: linux64
            os: ubuntu-latest
          - target: android
            os: ubuntu-latest

    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Android NDK
        if: matrix.target == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install depot_tools
        shell: bash
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools
          # On Windows, we use GITHUB_PATH with the appropriate path syntax
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "$HOME/depot_tools" >> $GITHUB_PATH
          else
            echo "$HOME/depot_tools" >> $GITHUB_PATH
          fi

      # REQUIRED: Setup MSVC Environment for Windows (fixes "CMAKE_C_COMPILER not set")
      - name: Setup MSVC
        if: matrix.target == 'win64'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install ninja (linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install ninja-build

      - name: Install ninja (macos)
        if: matrix.os == 'macos-latest'
        run: brew install ninja

      - name: Install ninja (windows)
        if: matrix.os == 'windows-latest'
        run: choco install ninja

      - name: Install linux dependencies
        if: matrix.target == 'linux64'
        run: |
          sudo apt-get install libxrandr-dev libxinerama-dev libx11-dev libxcursor-dev libxi-dev \
            libxext-dev libxcb-shm0-dev libxtst-dev libx11-xcb-dev

      - name: Build dawn
        env:
          MACOSX_DEPLOYMENT_TARGET: "11.0"
          DEPOT_TOOLS_WIN_TOOLCHAIN: 0
        shell: bash
        run: |
          EXTRA_CMAKE_ARGS=""
          
          if [ "${{ matrix.target }}" == "win64" ]; then
            # DYNAMICALLY FIND NINJA
            # 'where.exe' finds all instances. grep finds the one installed by choco.
            # tr removes Windows carriage returns.
            RAW_NINJA_PATH=$(where.exe ninja | grep "chocolatey" | head -n 1 | tr -d '\r')
            
            # Convert backslashes to forward slashes for CMake safety in Bash
            NINJA_PATH="${RAW_NINJA_PATH//\\//}"
            
            echo "Using Ninja binary at: $NINJA_PATH"
            
            EXTRA_CMAKE_ARGS="-G Ninja -DDAWN_USE_BUILT_DXC=ON -DCMAKE_MAKE_PROGRAM=\"$NINJA_PATH\""
          fi

          if [ "${{ matrix.target }}" == "macos64" ]; then
            EXTRA_CMAKE_ARGS="-DCMAKE_OSX_ARCHITECTURES=x86_64;arm64"
          fi

          if [ "${{ matrix.target }}" == "android" ]; then
             EXTRA_CMAKE_ARGS="-DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake \
               -DANDROID_ABI=arm64-v8a \
               -DANDROID_PLATFORM=android-30 \
               -DDAWN_USE_X11=OFF \
               -DDAWN_USE_WAYLAND=OFF \
               -DTINT_BUILD_SPV_READER=ON"
          fi
          
          ./scripts/build $EXTRA_CMAKE_ARGS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dawn-static-${{ matrix.target }}
          path: |
            build/gen/**/*
            build/lib/**/*

  release:
    runs-on: ubuntu-latest
    needs: build
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Create git tag
        id: create-git-tag
        run: |
          tag="autobuild-$(date -u '+%Y-%m-%d-%H-%M')"
          git tag $tag
          git push origin $tag
          echo "TAG=$tag" >> $GITHUB_OUTPUT
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Prepare artifacts
        run: |
          for target in win64 macos64 linux64 android; do
            # Create a directory if it doesn't exist
            mkdir -p dawn-static-$target
            echo "${{ steps.create-git-tag.outputs.COMMIT }}" > dawn-static-$target/COMMIT
            tar -czvf dawn-static-$target.tar.gz dawn-static-$target/
          done

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.create-git-tag.outputs.TAG }} dawn-static-*.tar.gz \
            -n "dawn@${{ steps.create-git-tag.outputs.COMMIT }}"
