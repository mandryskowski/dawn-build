name: build

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        target:
          - win64
          - macos64
          - linux64
          - android
        include:
          - target: win64
            os: windows-latest # CHANGED: Switched to native Windows runner
          - target: macos64
            os: macos-latest
          - target: linux64
            os: ubuntu-latest
          - target: android
            os: ubuntu-latest

    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Android NDK
        if: matrix.target == 'android'
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install depot_tools
        shell: bash
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git $HOME/depot_tools
          # On Windows, we use GITHUB_PATH with the appropriate path syntax
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "$HOME/depot_tools" >> $GITHUB_PATH
          else
            echo "$HOME/depot_tools" >> $GITHUB_PATH
          fi

      # REMOVED: Cache windows sdk (MSVC is pre-installed)
      # REMOVED: Download windows sdk (xwin is not needed)

      - name: Install ninja (linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install ninja-build

      - name: Install ninja (macos)
        if: matrix.os == 'macos-latest'
        run: brew install ninja

      - name: Install ninja (windows)
        if: matrix.os == 'windows-latest'
        run: choco install ninja

      # REMOVED: Install windows dependencies (clang/llvm on linux not needed)

      - name: Install linux dependencies
        if: matrix.target == 'linux64'
        run: |
          sudo apt-get install libxrandr-dev libxinerama-dev libx11-dev libxcursor-dev libxi-dev \
            libxext-dev libxcb-shm0-dev libxtst-dev libx11-xcb-dev

      # REMOVED: Setup cmake toolchain for windows (MSVC is native)

      - name: Build dawn
        env:
          MACOSX_DEPLOYMENT_TARGET: "11.0"
          DEPOT_TOOLS_WIN_TOOLCHAIN: 0
        # Use cmd to wrap the call in the Visual Studio environment
        shell: cmd
        run: |
          :: 1. Initialize MSVC environment variables
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"

          :: 2. Set up arguments (manually for cmd)
          set EXTRA_CMAKE_ARGS=-G Ninja -DDAWN_FORCE_SYSTEM_COMPONENT_LOAD=ON -DDAWN_USE_BUILT_DXC=ON -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl

          :: 3. Run the build script using the Bash interpreter explicitly
          :: We use the system Ninja to avoid the depot_tools version error
          "C:\Program Files\Git\bin\bash.exe" ./scripts/build %EXTRA_CMAKE_ARGS%

          
          ./scripts/build $EXTRA_CMAKE_ARGS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dawn-static-${{ matrix.target }}
          path: |
            build/gen/**/*
            build/lib/**/*

  release:
    runs-on: ubuntu-latest
    needs: build
    if: success() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout git repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Create git tag
        id: create-git-tag
        run: |
          tag="autobuild-$(date -u '+%Y-%m-%d-%H-%M')"
          git tag $tag
          git push origin $tag
          echo "TAG=$tag" >> $GITHUB_OUTPUT
          # Assuming 'dawn' is a submodule or directory within the repo
          echo "COMMIT=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Prepare artifacts
        run: |
          for target in win64 macos64 linux64 android; do
            # Create a directory if it doesn't exist (artifact download usually creates it)
            mkdir -p dawn-static-$target
            echo "${{ steps.create-git-tag.outputs.COMMIT }}" > dawn-static-$target/COMMIT
            tar -czvf dawn-static-$target.tar.gz dawn-static-$target/
          done

      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.create-git-tag.outputs.TAG }} dawn-static-*.tar.gz \
            -n "dawn@${{ steps.create-git-tag.outputs.COMMIT }}"
